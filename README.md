# DFaaS: Decentralized Function-as-a-Service for Federated Edge

## Motivating scenario

![Scenario](images/Scenario-crop.png)

The above figure depicts the considered network scenario. A set of geographically-distributed _FaaS-enabled edge nodes_ (or simply _edge nodes_) is deployed at the edge of the access network. 

Each of these nodes deploys a _DFaaS platform_ for the execution of _serverless functions_, and is connected to a wireless or wired _access point_ (e.g. a base station, a broadband network gateway, a WiFi access point, etc.).

The edge node can receive functions' execution _requests_, in the form of HTTP requests, generated by the _users_ served by the access point.

## Architecture

![Architecture](images/Arch-crop.png)

## Prototype architecture

![Prototype Architecture](images/prototype.png)

The current prototype runs 4 virtual machines (VM):

- 3 VMs execute a single-node OpenFaaS platform
- 1 VM executes all the containers implmenting the Agent and the Proxy components

## How to run the prototype

> NOTE: The following steps illustrate how to run the prototype from a Windows-based host exploting the Windows Subsystem for Linux (WSL). Unix users can skip the preliminary steps and ignore Windows-specific instructions.

### Preliminary steps for a Windows-based host

- Install chocolatey (https://chocolatey.org/install)
- Open a terminal with admin privileges and execute the command `choco install gsudo git virtualbox php faas-cli golang` to install the required packets
- Optional: open Git Bash and execute: `curl -o "$HOME/.minttyrc" https://raw.githubusercontent.com/dmotte/minttyrc/master/.minttyrc`
- Install WSL, the Debian distro is strongly suggested
- Append the content of the file `ssh-client-config/ssh-client-config.txt` to `C:\Program Files\Git\etc\ssh`
- Install Ansible within WSL (https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-on-debian)
- Install `rsync` within WSL (e.g., `sudo apt install rsync` if you are using Debian or Ubuntu)
- Install `wget` for Git Bash:
  - Download the executable `wget.exe` from https://eternallybored.org/misc/wget/
  - Move it to the `bin` of Git (`C:\Program Files\Git\mingw64\bin\`)
  - Open a Git Bash and execute the command `export PATH=$PATH:/c/Program\ Files/Git/mingw64/bin/`

### Create the VMs

- Edit the line `DEBIAN_ISO_LOCAL_PATH` within files `01-vbox-nodes/main.sh` and `02-vbox-dfaasctrl/main.sh` to an existing path
- Run the script `01-vbox-nodes/main.sh` within *Git Bash*
- Run the script `02-vbox-dfaasctrl/main.sh` within *Git Bash*
  - Optional: if you have few RAM (e.g. <= 8GB) it is strongly suggested to reduce the VM RAM. Open Virtual Box and follow these steps for each VM: `Select a VM > Settings > System > Edit RAM` and set it for example to 1536 MB

### Install Debian for each DFaaSNode VM

- Run the webserver with the script `03-preseed-nodes/serve.sh` within *Git Bash*
- For each of the `DFaaSNode*` VM:
  - Run the VM
  - Press `ESC` during boot
  - Run the boot command `auto url=http://192.168.0.105:8080/preseed-*.cfg` (change `*` with the VM number, e.g., `preseed-01.cfg` and `192.168.0.105` with your host IP)
  - Wait until the VM is shutdown
- Stop the webserver

### Install Debian on the DFaaSCtrl VM

- Run the webserver with the script `04-preseed-nodes/serve.sh` within *Git Bash*
- Run the VM `DFaaSCtrl`
- Press `ESC` during boot
  - Run the boot command `auto url=http://192.168.0.105:8080/preseed.cfg` (change `192.168.0.105` with your host IP)
  - Wait until the VM is shutdown
- Stop the webserver

### Install OpenFaaS on the DFaaSNode VMs

> NOTE: to access the VMs the SSH/FTP credentials are the following
> - node01.dfaas.lvh.me:12201 username: `debian`, password: `debpass2020`
> - node02.dfaas.lvh.me:12202 username: `debian`, password: `debpass2020`
> - node03.dfaas.lvh.me:12203 username: `debian`, password: `debpass2020`
> - ctrl.dfaas.lvh.me:12200 username: `debian`, password: `debpass2020`

- Run the 3 `DFaaSNode*` VMs
- For each VM copy the script `05-bash-nodes/setup-packages.sh` in the home directory and execute with root privileges


### Deploy dummy functions in OpenFaaS
- Move within `example-functions` directory and execute `faas-cli template store pull golang-http` within *Git Bash* to pull the templates. Then go back to the root project directory
- Ensure you have all the 4 VM running
- Execute the script `06-ansible-playbooks/reset-ssh-keys-wsl.sh` within *Git Bash*
- Execute the script `06-ansible-playbooks/script-setup-client.sh` within *Git Bash*
- Execute the script `06-ansible-playbooks/script-setup-functions.sh` within *Git Bash* (it MUST be execute once only)
  - To deploy Prometheus Exporters execute the script `06-ansible-playbooks/script-deploy-exporters.sh` within *Git Bash* (you can ignore warning/errors during the execution of this script)
- Execute the script `06-ansible-playbooks/script-deploy-functions.sh` within *Git Bash* (it can be executed multiple times to re-deploy the functions)

### Configure the DFaaSCtrl VM

- Execute the script `06-ansible-playbooks/script-setup-server.sh` within *Git Bash* (it MUST be execute once only)
- Execute the script `06-ansible-playbooks/script-deploy.sh` within *Git Bash* (it can be executed multiple times)

## How to test the prototype is working correctly

> Note: to send request to functions from the host machine
> - http://node01.dfaas.lvh.me:18001/function/funca
> - http://node02.dfaas.lvh.me:18002/function/funca
> - http://node03.dfaas.lvh.me:18003/function/funca

> Note: to send request to functions from the DFaaSCtrl VM
> - http://127.0.0.1:8001/function/funca
> - http://127.0.0.1:8002/function/funca
> - http://127.0.0.1:8003/function/funca

For instance, execute the command `ssh dfaasctrl` within _Git Bash_ to connect to the DFaaSCtrl VM. Then, you can execute a function request using cURL:

```bash
curl http://192.168.15.50:8001/function/funca
```

WARNING! You have to wait some time (`recalc-period`) to have working functions. If you want to change the `recalc-period`, edit the parameter `--recalc-period` within the `playbook-deploy.yml` file.

For a complete test you can execute the script `vegeta-testing-script/vegeta-testing-script.sh`. This script MUST be copied and executed within the home directory of the DFaaSCtrl VM. The test results will be stored within the directory `/home/debian/vegeta-results`.
